<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>World Infini</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    html, body {
      margin: 0; padding: 0; overflow: hidden; background: black;
      font-family: 'Press Start 2P', monospace;
      user-select: none;
    }
    #gameCanvas {
      display: block;
      background: black;
    }
    #loading {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: black;
      color: white;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #coords {
      position: fixed;
      top: 10px; right: 10px;
      color: white;
      font-size: 12px;
      z-index: 10;
      background: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 5px;
    }
    #menuBtn {
      position: fixed;
      top: 10px; left: 10px;
      background: white;
      font-size: 14px;
      padding: 8px 15px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      display: none;
      z-index: 10;
      transition: background-color 0.3s;
    }
    #menuBtn:hover {
      background: #ddd;
    }
    #menuPopup {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      color: white;
      padding: 30px 40px;
      font-size: 16px;
      border-radius: 15px;
      box-shadow: 0 0 15px #00ff00aa;
      display: none;
      z-index: 10000;
      text-align: center;
      width: 250px;
    }
    #menuPopup button {
      margin-top: 20px;
      padding: 10px 20px;
      font-family: 'Press Start 2P';
      font-size: 14px;
      background: #00ff00;
      border: none;
      border-radius: 10px;
      color: black;
      cursor: pointer;
      transition: background-color 0.3s;
      width: 100%;
    }
    #menuPopup button:hover {
      background: #00cc00;
    }
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>

  <div id="loading">Chargement...</div>
  <button id="menuBtn">MENU</button>
  <div id="coords"></div>
  <div id="menuPopup" role="dialog" aria-modal="true" aria-labelledby="menuTitle">
    <div id="menuTitle" style="font-size:18px; margin-bottom:10px;">Menu</div>
    <button id="resumeBtn">Reprendre</button>
    <button id="quitBtn">Sauvegarder et Quitter</button>
  </div>

  <canvas id="gameCanvas"></canvas>
  <!-- Affichage des cœurs -->
<div id="heartsContainer" style="position:fixed; top:10px; right:10px; z-index:20;"></div>

<!-- Écran de mort -->
<div id="deathScreen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; color:white; font-family:'Press Start 2P'; z-index:1000; justify-content:center; align-items:center; flex-direction:column;">
  <p style="font-size: 20px; margin-bottom: 20px;">Vous avez succombé.</p>
  <button id="respawnBtn">Réapparaître</button>
  <button id="exploreBtn">Explorer</button>
  <button id="quitBtnTop">Quitter</button>
  <!-- Inventaire -->
<div id="inventory" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
  background:#222; border:3px solid #00ff00; padding:20px; z-index:1000; font-family:'Press Start 2P'; color:white;">
  <h3 style="margin-top:0;">Inventaire</h3>
  <div id="crafting" style="margin-bottom:15px;">Menu de fabrication (bientôt)</div>
  <div id="invGrid" style="display:grid; grid-template-columns: repeat(9, 40px); gap:5px;"></div>
</div>

</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
  authDomain: "kykychat-24c7f.firebaseapp.com",
  databaseURL: "https://kykychat-24c7f-default-rtdb.firebaseio.com",
  projectId: "kykychat-24c7f",
  storageBucket: "kykychat-24c7f.appspot.com",
  messagingSenderId: "342562811927",
  appId: "1:342562811927:web:0fed1e1f511c4fddcfec52"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let uid, currentWorld;
let player = { x: 100, y: 100 };
let inGameMinutes = 12 * 60;
let currentDay = 1;
let hearts = 10, maxHearts = 10;
let inventory = {};
let treePositions = [];
let uniqueMode = false;

const maxStack = 64;
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const camera = { x: 0, y: 0 };

// ========== Auth ==========

auth.onAuthStateChanged(async user => {
  if (!user) return location.href = "index.html";
  uid = user.uid;

  document.getElementById("loading").style.display = "flex";

  const playingSnap = await db.ref(`users/${uid}/playing`).once("value");
  currentWorld = playingSnap.val();
  if (!currentWorld || currentWorld === "Ecran d'accueil") {
    return location.href = "play.html";
  }

  // Chargement coordonnées
  const coordsSnap = await db.ref(`users/${uid}/worlds/${currentWorld}/playerinfos/coords`).once("value");
  if (coordsSnap.exists()) {
    const val = coordsSnap.val();
    player.x = parseFloat(val.x) || 100;
    player.y = parseFloat(val.y) || 100;
  }

  // Heure
  const dateSnap = await db.ref(`users/${uid}/worlds/${currentWorld}/date`).once("value");
  if (dateSnap.exists()) {
    const [h, m] = dateSnap.val().split(":").map(Number);
    inGameMinutes = h * 60 + m;
  }

  // Jour
  const daySnap = await db.ref(`users/${uid}/worlds/${currentWorld}/day`).once("value");
  if (daySnap.exists()) currentDay = daySnap.val();

  // Cœurs
  const heartsSnap = await db.ref(`users/${uid}/worlds/${currentWorld}/playerinfos/hearts`).once("value");
  if (heartsSnap.exists()) {
    hearts = heartsSnap.val();
  } else {
    hearts = maxHearts;
    await db.ref(`users/${uid}/worlds/${currentWorld}/playerinfos/hearts`).set(hearts);
  }

  // Mode unique
  const uniqueSnap = await db.ref(`users/${uid}/worlds/${currentWorld}/unique`).once("value");
  uniqueMode = uniqueSnap.exists() && uniqueSnap.val() === true;

  // Inventaire
  const invSnap = await db.ref(`users/${uid}/worlds/${currentWorld}/inventory`).once("value");
  if (invSnap.exists()) {
    inventory = invSnap.val();
  } else {
    inventory = {};
  }

  // Arbres
  await loadOrGenerateTrees();

  // Présence en ligne
  await db.ref(`presence/${uid}`).set(true);

  updateHeartsUI();
  renderInventory();
  document.getElementById("loading").style.display = "none";

  requestAnimationFrame(gameLoop);
});

// ========== Arbres ==========

async function loadOrGenerateTrees() {
  const treesSnap = await db.ref(`users/${uid}/worlds/${currentWorld}/trees`).once("value");
  if (treesSnap.exists()) {
    treePositions = treesSnap.val();
  } else {
    treePositions = [];
    for (let i = 0; i < 10; i++) {
      treePositions.push({ x: Math.random() * 800 + 100, y: Math.random() * 600 + 100 });
    }
    await db.ref(`users/${uid}/worlds/${currentWorld}/trees`).set(treePositions);
  }

  treePositions = treePositions.map(tree => ({ ...tree, clickCount: 0 }));
}

// ========== Inventaire ==========

function addItemToInventory(item) {
  if (!inventory[item]) inventory[item] = 0;
  inventory[item] = Math.min(inventory[item] + 1, maxStack);
  db.ref(`users/${uid}/worlds/${currentWorld}/inventory`).set(inventory);
  renderInventory();
}

function renderInventory() {
  const invDiv = document.getElementById("inventory");
  invDiv.innerHTML = "";
  for (let item in inventory) {
    const el = document.createElement("div");
    el.textContent = `${item} x${inventory[item]}`;
    invDiv.appendChild(el);
  }
}

// ========== Clics sur arbres ==========

canvas.addEventListener("click", e => {
  if (!uid || !treePositions) return;
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;
  const worldX = camera.x + mouseX;
  const worldY = camera.y + mouseY;

  for (let i = 0; i < treePositions.length; i++) {
    const tree = treePositions[i];
    const dist = Math.hypot(tree.x - worldX, tree.y - worldY);
    if (dist < 30) {
      tree.clickCount = (tree.clickCount || 0) + 1;
      if (tree.clickCount >= 5) {
        addItemToInventory("tronc");
        treePositions.splice(i, 1);
        i--;
        db.ref(`users/${uid}/worlds/${currentWorld}/trees`).set(treePositions);
      }
    }
  }
});

// ========== Touche E pour inventaire ==========

document.addEventListener("keydown", e => {
  if (e.key.toLowerCase() === "e") {
    const inv = document.getElementById("inventory");
    inv.style.display = inv.style.display === "none" ? "block" : "none";
    renderInventory();
  }
});

// ========== Boucle de jeu (à adapter) ==========

function gameLoop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Exemple : dessiner les arbres
  for (let tree of treePositions) {
    ctx.fillStyle = "green";
    ctx.beginPath();
    ctx.arc(tree.x - camera.x, tree.y - camera.y, 20, 0, Math.PI * 2);
    ctx.fill();
  }

  // Exemple : dessiner le joueur
  ctx.fillStyle = "blue";
  ctx.fillRect(player.x - camera.x - 10, player.y - camera.y - 10, 20, 20);

  requestAnimationFrame(gameLoop);
}

// ========== Cœurs ==========

function updateHeartsUI() {
  const el = document.getElementById("hearts");
  el.innerText = `❤ ${hearts} / ${maxHearts}`;
}


// Puis ta boucle principale gameLoop utilise `monsters`

</script>
  
</body>
</html>
