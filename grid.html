<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Grille des Caméras</title>
  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 10px;
      width: 100vw;
      height: 100vh;
      padding: 10px;
      box-sizing: border-box;
    }

    .cam-slot {
      position: relative;
      background: #222;
      border: 2px solid #444;
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cam-slot video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .label {
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(0,255,0,0.6);
      padding: 2px 6px;
      font-size: 12px;
      font-weight: bold;
      border-radius: 3px;
    }

    .no-data {
      font-size: 24px;
      color: #777;
    }
  </style>
</head>
<body>
  <div class="grid" id="grid"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    // ----- Firebase Config -----
    const firebaseConfig = {
      apiKey: "AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
      authDomain: "kykychat-24c7f.firebaseapp.com",
      databaseURL: "https://kykychat-24c7f-default-rtdb.firebaseio.com",
      projectId: "kykychat-24c7f",
      storageBucket: "kykychat-24c7f.appspot.com",
      messagingSenderId: "342562811927",
      appId: "1:342562811927:web:0fed1e1f511c4fddcfec52"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const grid = document.getElementById("grid");
    const MAX_SLOTS = 4; // 2x2 grid

    // ----- Fonction pour charger les caméras actives -----
    async function loadGrid() {
      const snapshot = await db.ref("cameras").once("value");
      const cameras = snapshot.val() || {};
      const now = Date.now();

      // Filtrer caméras actives (ping < 30s)
      const activeCams = Object.values(cameras)
        .filter(c => c.timestamp && now - c.timestamp < 30000)
        .slice(0, MAX_SLOTS);

      // Effacer et remplir la grille
      grid.innerHTML = "";

      for (let i = 0; i < MAX_SLOTS; i++) {
        const cam = activeCams[i];

        const slot = document.createElement("div");
        slot.className = "cam-slot";

        if (cam) {
          // STREAM LOCAL UNIQUEMENT SI DEVICE = LOCALHOST
          const label = document.createElement("div");
          label.className = "label";
          label.textContent = cam.name;
          slot.appendChild(label);

          const video = document.createElement("video");
          video.autoplay = true;
          video.muted = true;
          video.playsInline = true;

          // Comme on ne peut pas streamer à distance sans WebRTC setup complet,
          // on utilise un faux flux noir (sinon ça crash)
          const fakeStream = new MediaStream();
          video.srcObject = fakeStream;
          video.style.background = "#000";

          slot.appendChild(video);

        } else {
          // Case vide
          const text = document.createElement("div");
          text.className = "no-data";
          text.textContent = "NO DATA";
          slot.appendChild(text);
        }

        grid.appendChild(slot);
      }
    }

    // Auto-refresh toutes les 5 secondes
    loadGrid();
    setInterval(loadGrid, 5000);
  </script>
</body>
</html>
