<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Chargement du Monde</title>
  <style>
    body {
      font-family: 'Press Start 2P', cursive, monospace;
      background: #121212;
      color: #eee;
      text-align: center;
      padding: 30px;
    }
    #tips {
      margin: 20px auto;
      font-size: 14px;
      height: 30px;
    }
    button {
      background: #0078D7;
      border: none;
      padding: 10px 20px;
      font-family: 'Press Start 2P', cursive;
      font-size: 12px;
      color: white;
      cursor: pointer;
      margin-top: 30px;
    }
    #errorMessage {
      color: red;
      margin-top: 40px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>Vérification de la disponibilité...</h1>
  <div id="tips"></div>
  <div id="errorMessage"></div>
  <button id="backBtn">Retour à l'accueil</button>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // === Initialise Firebase ici ===
    const firebaseConfig = {
      // ... tes config Firebase ...
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // Liste d'astuces
    const tips = [
      "Astuce 1 : N'oublie pas de sauvegarder souvent !",
      "Astuce 2 : Utilise la touche 'F' pour accéder rapidement à ton inventaire.",
      "Astuce 3 : Explore les cavernes pour trouver des ressources rares.",
      "Astuce 4 : Construis un abri avant la nuit pour éviter les monstres.",
      "Astuce 5 : Utilise des torches pour éclairer ton chemin."
    ];

    const tipsDiv = document.getElementById('tips');
    const errorDiv = document.getElementById('errorMessage');
    const backBtn = document.getElementById('backBtn');

    let currentTipIndex = -1;

    function showRandomTip() {
      let nextIndex;
      do {
        nextIndex = Math.floor(Math.random() * tips.length);
      } while (nextIndex === currentTipIndex);
      currentTipIndex = nextIndex;
      tipsDiv.textContent = tips[currentTipIndex];
    }

    // Changer l'astuce toutes les 6 secondes
    showRandomTip();
    const tipInterval = setInterval(showRandomTip, 6000);

    // Récupère l'UID du joueur connecté
    let currentUserUid = null;
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUserUid = user.uid;
      } else {
        // Pas connecté, on redirige
        window.location.href = "index.html";
      }
    });

    // Fonction pour remettre playing à "Ecran d'accueil" et retourner à index.html
    function backToHome() {
      if (!currentUserUid) {
        window.location.href = "index.html";
        return;
      }
      db.ref(`users/${currentUserUid}/playing`).set("Ecran d'accueil").then(() => {
        window.location.href = "index.html";
      }).catch(() => {
        window.location.href = "index.html";
      });
    }

    backBtn.addEventListener('click', backToHome);

    // Vérification de la disponibilité
    function checkDisponibility() {
      const disponibilityRef = db.ref('disponibility');

      disponibilityRef.once('value').then(snapshot => {
        if (!snapshot.exists()) {
          // Crée la clé dispo avec true si elle n'existe pas
          disponibilityRef.set(true);
          // Tout est OK, on laisse la page telle quelle (message + astuces)
        } else {
          const val = snapshot.val();
          if (val === true) {
            // Disponibilité OK, on reste sur la page de chargement
          } else {
            // Valeur autre que true : on affiche erreur
            clearInterval(tipInterval);
            document.querySelector('h1').textContent = "Erreur de connexion au monde : " + val;
            tipsDiv.textContent = "";
            errorDiv.textContent = "";
            backBtn.style.display = "inline-block";
          }
        }
      }).catch(error => {
        clearInterval(tipInterval);
        document.querySelector('h1').textContent = "Erreur lors de la vérification : " + error.message;
        tipsDiv.textContent = "";
        backBtn.style.display = "inline-block";
      });
    }

    // Check disponibility dès que l'UID est défini (on attend max 5s)
    function waitForUserAndCheck() {
      if (currentUserUid) {
        checkDisponibility();
      } else {
        setTimeout(waitForUserAndCheck, 500);
      }
    }
    waitForUserAndCheck();

  </script>
</body>
</html>
