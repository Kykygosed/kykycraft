<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Partager ma caméra</title>
  <style>
    body {
      background: #111;
      color: white;
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    video {
      width: 100%;
      max-height: 60vh;
      background: black;
      margin-bottom: 10px;
    }

    select, input, button {
      padding: 8px;
      margin: 5px 0;
      font-size: 16px;
      width: 100%;
    }

    .status {
      margin-top: 10px;
      color: lightgreen;
    }

    .error {
      color: red;
    }
  </style>
</head>
<body>
  <h2>🎥 Partage de caméra</h2>

  <video id="video" autoplay playsinline muted></video>

  <select id="cameraSelect"></select>
  <input type="text" id="deviceName" placeholder="Nom de votre appareil (ex: PC-kyky)">
  <button id="startBtn">🎬 Démarrer</button>
  <div class="status" id="status">En attente...</div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
      authDomain: "kykychat-24c7f.firebaseapp.com",
      databaseURL: "https://kykychat-24c7f-default-rtdb.firebaseio.com",
      projectId: "kykychat-24c7f",
      storageBucket: "kykychat-24c7f.appspot.com",
      messagingSenderId: "342562811927",
      appId: "1:342562811927:web:0fed1e1f511c4fddcfec52"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const video = document.getElementById("video");
    const cameraSelect = document.getElementById("cameraSelect");
    const startBtn = document.getElementById("startBtn");
    const deviceNameInput = document.getElementById("deviceName");
    const status = document.getElementById("status");

    let currentStream = null;

    // 🔍 Liste les caméras disponibles
    async function listCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === "videoinput");

        cameraSelect.innerHTML = "";
        videoDevices.forEach(device => {
          const option = document.createElement("option");
          option.value = device.deviceId;
          option.textContent = device.label || "Caméra " + (cameraSelect.length + 1);
          cameraSelect.appendChild(option);
        });

        if (videoDevices.length === 0) {
          status.textContent = "Aucune caméra détectée.";
          status.classList.add("error");
        }
      } catch (err) {
        status.textContent = "Erreur de détection des caméras.";
        status.classList.add("error");
        console.error(err);
      }
    }

    // 🎬 Démarre le flux vidéo
    async function startStream() {
      if (!deviceNameInput.value.trim()) {
        alert("Veuillez entrer un nom pour l'appareil.");
        return;
      }

      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
      }

      try {
        const constraints = {
          video: {
            deviceId: { exact: cameraSelect.value }
          },
          audio: false
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        video.srcObject = stream;

        status.textContent = "🎥 Caméra activée.";

        // 🔄 Ping Firebase toutes les 10s
        const name = deviceNameInput.value.trim();
        const update = () => {
          db.ref("cameras/" + name).set({
            name: name,
            timestamp: Date.now()
          });
        };
        update();
        setInterval(update, 10000);

      } catch (err) {
        console.error("Erreur de démarrage de la caméra :", err);
        status.textContent = "Erreur : impossible de démarrer la caméra.";
        status.classList.add("error");
      }
    }

    // 📦 Initialisation
    listCameras();

    startBtn.addEventListener("click", () => {
      startStream();
    });

    // 🔁 Met à jour les caméras disponibles si on branche une nouvelle
    navigator.mediaDevices.addEventListener("devicechange", listCameras);
  </script>
</body>
</html>
